# Многопользовательская авторизация/Keycloak Multi-Tenancy на SPI Keycloak orgs от Phase two.


**Мультитенантность** (англ. multitenancy — множественная аренда) — **элемент архитектуры программного обеспечения, где единый экземпляр приложения обслуживает множество организаций-клиентов («арендаторов»)**

Keycloak из коробки (vanila KC) предоставляет полную изоляцию тенантов друг от друга. Полностью исключая любое, даже преднамеренное воздействие на другой тенант. Каждый тенант имеет доступ только к собственным данным, пользователям, настройкам и т.д. Поэтому для реализации multi-tenancy необходимо кастомизировать функционал Keycloak. 

Keycloak известен, как сервис управления аутентификацией и доступами, функционал которого легко можно расширять с помощью плагинов SPI. Кастомизация интерфейсов поставщиков услуг (SPI) подробно описана и легко реализуема. 
Использование плагинов позволяет Keycloak расширять основные протоколы аутентификации и авторизации по желанию разработчиков. Добавлять необходимый функционал в соответствии с бизнес требованиями.

![[img_1.png]]

## Общий подход к реализации multi-tenancy в Keycloak.

На текущий момент Keycloak не предоставляет возможность реализации multi-tenancy из коробки. 
Создание и использование пользовательских аутентификаторов, мапперов протоколов, REST-ресурсов, JPA-сущностей, провайдеров моделей и т. д. для каждого тенанта производится в рамках одного пространства - Realm. Realm  - изолированные пространства в Keycloak. Между ними нет общих клиентов или поставщиков персональных данных. Пользователь/администратор из одного пространства не может получить информацию о пользователях из другого пространства. 

Чтобы реализовать функционал multi-tenancy можем использовать три варианта :

### 1 Realm - N tenant.
*Объединение всех клиентов, пользователей и настроек в одной области.*

Объединить всех поставщиков персональных данных, клиентов, и пр. в одном Realm. И использовать управление пользователями на уровне ролей в рамках одного Realm. 
Для этого подходит можно использовать реализацию групп пользователей (Group KC). Определив для каждого тенанта отдельную группу, добавив соответсвующие роли, и  отдельного клиента. Однако на данный момент в релизной версии Keycloak нет достаточных прав администратора, представляющих детализированный контроль группой или группами пользователей. Поэтому по мере увеличения ролей в каждой организации будет будет увеличиваться сложность поддержки такого сервиса.


### 1 Realm - 1 Tenant.
*Создание отдельной области для каждого тенанта.*

В этом случае нужно настроить каждого клиента или нескольких клиентов в каждом Realm. И каждый клиент должен уметь обрабатывать всех поставщиков персональных данных и всех URI от каждого Realm. При добавлении нового тенанта нужно добавлять новый Realm и на лету нужно добавлять информацию о нем в каждый клиент. 
Здесь есть ограничение на масштабируемость, разные пользователи сообщают от максимальном количестве не превышающем ~300~400 Realms. Так же такой подход усложняет управление настройками доступа для каждого тенанта. 

### N tenant-reams - 1 app realm
*Создание общей области для приложений и клиентов.*

Для каждого тенанта создается отдельный Realm (tenant-realm). И отдельно создается Realm для приложения(app-realm). App-realm является прокси для идентификации тенантов. Все приложения используют клиенты app-realm. Пользовать проходит аутентификацию в tenant-realm, затем переправляется в app-realm. Это позволяет администраторам тенанта управлять только своими пользователями. 
В этом случае будет наблюдаться дублирование ресурсов. В tenant-realm пользователь проходит аутентификацию, ему создается контекст и это контекст будет продублирован в app-realm. Создаются две пользовательские сессии. Аллоцируется x2 памяти и дублируются данные в обоих хранилищах в tenant-realm и app-realm. 


## 1 Realm - N tenant на примере SPI Keycloak-orgs

В этом статье рассмотрим SPI от команды Phase Two - keycloak-orgs. Предлагаемое  решение реализует подход 1 Realm - N tenant. 
SPI Расширяет основной сервер Keycloak сущностями, моделирующими организации (тенантов) и связанные с ними пользователи, роли и поставщики идентификационных данных. Это отличный пример, как использовать архитектуру плагинов Keycloak для решения задач, не решаемых его основной функциональностью.

Особенности реализации SPI Keycloak-orgs :
- Организация (tenant) является объектом верхнего уровня. Пользователь может быть членом разных организаций. 
- Делегируется  управление организацией : управление сотрудниками, приглашения, управления ролями и авторизиацией.
- Весь функционал доступнен по Rest API
- Расширение Keyclock UI 

## Use case (????)

Компания "Thomson & French" предоставляет информационные услуги компаниям "Morel & Son" и "Ali Pasha".
Перед компанией стоят задачи управления доступом:
 1. Изоляция доступа к ресурсам. Таким образом, чтобы сотрудники "Morel & son" не имели доступа к ресурсам компании-клиента "Ali Pasha".
 2. Управление доступами к ресурсам внутри компании-клиента. Таким образом, что администраторы компании "Ali Pasha" самостоятельно определяли уровни доступа сотрудников к ресурсам компании "Ali Pasha".
 3. Управление учетными записями. Таким образом, что администраторы компании "Morel & Son" самостоятельно приглашали, удаляли сотрудников, которым предоставлен доступ к ресурсам компании "Morel & Son" и не имели доступа к сотрудникам компании "Ali Pasha".
 4. Приоритетное управление доступом к ресурсам и пользователями. Таким образом, что администраторы компании "Thomson & French" могут управлять доступом ресурсам и пользователями компаний "Ali Pasha", "Morel & Son".

## Рабочий процесс

Наши следующие шаги :
1. Развернем рабочее окружение Keycloak с плагином SPI .
2. Создадим организацию.
3. Создадим пользователя.
5. Добавим пользователя в организацию.
6. Рассмотрим из чего состоит токен доступа.
7. Рассмотрим портал организатора.
8. Рассмотрим, какие ограничения есть у данного плагина.



